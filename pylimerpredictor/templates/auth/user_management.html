{% extends 'base.html' %}

{% block title %}User Management - Pylimer Predictor{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>User Management</h2>
  <span class="badge bg-info">{{ users.count }} total users</span>
</div>

<div class="card">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Username</th>
            <th>Institution</th>
            <th>Role</th>
            <th>Status</th>
            <th>Joined</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user_item in users %}
            <tr {% if not user_item.is_active %}class="table-secondary"{% endif %}>
              <td>
                <strong>{{ user_item.full_name }}</strong>
                {% if user_item == user %}
                  <span class="badge bg-primary">You</span>
                {% endif %}
              </td>
              <td>{{ user_item.email }}</td>
              <td>{{ user_item.username }}</td>
              <td>{{ user_item.institution|default:"-" }}</td>
              <td>
                <form method="post" action="{% url 'update_user_role' user_item.id %}" class="d-inline">
                  {% csrf_token %}
                  <select name="role" class="form-select form-select-sm" 
                          onchange="this.form.submit()"
                          {% if user_item == user %}disabled{% endif %}>
                    {% for role_value, role_label in user_item.ROLE_CHOICES %}
                      <option value="{{ role_value }}" 
                              {% if user_item.role == role_value %}selected{% endif %}>
                        {{ role_label }}
                      </option>
                    {% endfor %}
                  </select>
                </form>
              </td>
              <td>
                {% if user_item.is_active %}
                  <span class="badge bg-success">Active</span>
                {% else %}
                  <span class="badge bg-danger">Inactive</span>
                {% endif %}
              </td>
              <td>{{ user_item.created_at|date:"M d, Y" }}</td>
              <td>
                {% if user_item != user %}
                  <form method="post" action="{% url 'toggle_user_active' user_item.id %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm 
                            {% if user_item.is_active %}btn-outline-danger{% else %}btn-outline-success{% endif %}"
                            onclick="return confirm('Are you sure you want to {% if user_item.is_active %}deactivate{% else %}activate{% endif %} this user?')">
                      {% if user_item.is_active %}Deactivate{% else %}Activate{% endif %}
                    </button>
                  </form>
                {% else %}
                  <span class="text-muted">-</span>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="8" class="text-center text-muted">No users found.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="row mt-4">
  <div class="col-md-4">
    <div class="card">
      <div class="card-body text-center">
        <h5 class="card-title">Total Users</h5>
        <h3 class="text-primary">{{ users.count }}</h3>
      </div>
    </div>
  </div>
  
  <div class="col-md-4">
    <div class="card">
      <div class="card-body text-center">
        <h5 class="card-title">Researchers</h5>
        <h3 class="text-success">{{ users|length }}</h3>
        <small class="text-muted">
          {% with researcher_count=users|length %}
            {% for user_item in users %}
              {% if user_item.role == 'researcher' %}{{ forloop.counter0|add:1 }}{% endif %}
            {% endfor %}
          {% endwith %}
        </small>
      </div>
    </div>
  </div>
  
  <div class="col-md-4">
    <div class="card">
      <div class="card-body text-center">
        <h5 class="card-title">Active Users</h5>
        <h3 class="text-info">
          {% with active_count=0 %}
            {% for user_item in users %}
              {% if user_item.is_active %}{{ forloop.counter0|add:1 }}{% endif %}
            {% endfor %}
          {% endwith %}
        </h3>
      </div>
    </div>
  </div>
</div>

<script>
// Auto-submit role change forms with confirmation
document.addEventListener('DOMContentLoaded', function() {
  const roleSelects = document.querySelectorAll('select[name="role"]');
  roleSelects.forEach(select => {
    select.addEventListener('change', function(e) {
      const userName = this.closest('tr').querySelector('strong').textContent;
      const newRole = this.options[this.selectedIndex].text;
      
      if (!confirm(`Change ${userName}'s role to ${newRole}?`)) {
        // Reset to original value if cancelled
        this.selectedIndex = Array.from(this.options).findIndex(option => option.hasAttribute('selected'));
        e.preventDefault();
        return false;
      }
    });
  });
});
</script>
{% endblock %}
